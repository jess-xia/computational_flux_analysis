R version used: 4.5.1

## Prepare data for Analysis
Import gene expression data and convert to a dataframe
```{r}
# To install METAFlux
# devtools::install_github('KChen-lab/METAFlux')
library(METAFlux)
library(readxl)
```

```{r}
# Returns a tibble, does not support row names
GSC_culture_expression <- read_excel("C:/research/GBM_tissue_only_gene_expression_matrix.xlsx")

# Convert to dataframe and set the first column as rownames
GSC_culture_expression <- as.data.frame(GSC_culture_expression)
rownames(GSC_culture_expression) <- GSC_culture_expression[[1]]
GSC_culture_expression[[1]] <- NULL

head(GSC_culture_expression)

```

## Calculate Flux 
Calculate the MRAS (Metabolic Reaction Activity Score)
```{r}
# METAFlux only accepts positive values, replace negative values with a small positive number 
# Get positions (row/column) of non-positive values
# which(GSC_culture_expression <= 0, arr.ind = TRUE)
GSC_culture_expression[GSC_culture_expression < 0] <- 1e-5

GSC_scores <- calculate_reaction_score(GSC_culture_expression)
```

Calculate flux
```{r}
#Calculate flux for cell line data
GSC_flux <- compute_flux(mras=GSC_scores,medium = cell_medium) 
```
```{r}
# Save the flux results
write.csv(GSC_flux, "C:/research/computational_flux_analysis/GSC_tissue_bulk_METAFlux_flux_results.csv", row.names = TRUE)
```

```{r}
# Read in the flux results if previously saved
GSC_flux <- read.csv("C:/research/computational_flux_analysis/GSC_tissue_bulk_METAFlux_flux_results.csv",
                     row.names = 1)
head(GSC_flux)
```



## Assign Subtype Labels to GSC Lines
Using GSVA results, identify which cell lines are developmental and which are IR
Make metadata table based on GSVA results and reformat for PCA coloring
Looking at the GSVA scores, if dev > IR --> dev, else if dev < IR --> IR
```{r}
gsva_results <- read.csv("C:/research/GSC_RNAseq_and_metabolomics_analysis/gsva_results.csv",
                     row.names = 1)
gsva_results_t <- t(gsva_results)
gsva_results_t <- as.data.frame(gsva_results_t)

gsva_results_t$subtype <- ifelse(gsva_results_t$DEV_gs > gsva_results_t$IR_gs, "developmental", "injury_response")
```

## Make PCA plot
Question: Do the samples cluster together based on developmental/injury response subtype
Observation: It seems like they generally do quite well. This is as expected given that the flux values are calculated based on gene expression data

```{r}
# Transpose the flux matrix
GSC_flux_t <- t(GSC_flux)
```

Resolved error from running prcomp
```{r}
# Got an error: cannot rescale a constant/zero column to unit variance
# To resolve, identify columns that are entirely zero
all_zero_reactions <- names(which(colSums(GSC_flux_t) == 0))
length(all_zero_reactions)

# Print column given reaction name
# Example: reaction of interest
reaction_name <- "HMR_0024"

# Extract the column
reaction_flux <- GSC_flux_t[, reaction_name]

# Print it
print(reaction_flux)
```

```{r}
# Remove columns that are all zero
GSC_flux_t_nonzero <- GSC_flux_t[, colSums(GSC_flux_t) != 0]

# Check dimensions before and after
dim(GSC_flux_t)
dim(GSC_flux_t_nonzero)

# Create a PCA plot
pca <- prcomp(GSC_flux_t_nonzero, scale. = TRUE)  
```

Making the plot
```{r}
library(ggplot2)

# Convert to a data frame for ggplot
pca_df <- data.frame(
  Sample = rownames(pca$x),
  PC1 = pca$x[,1],
  PC2 = pca$x[,2]
)

merged_df <- merge(pca_df, gsva_results_t, by = "row.names", all.x = TRUE)

ggplot(merged_df, aes(x = PC1, y = PC2, color = subtype)) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "PCA of MetaFlux Data",
       x = paste0("PC1 (", round(summary(pca)$importance[2,1]*100,1), "%)"),
       y = paste0("PC2 (", round(summary(pca)$importance[2,2]*100,1), "%)"))

```

## Make Boxplots 
To compare fluxes between developmental and IR subtypes for specific reactions
```{r}
# Load the genome-scale metabolic model
data("human_gem")
data("nutrient_lookup_files")

# Identify reactions with tryptophan in the equation
# trp_matches <- grepl("tryptophan", human_gem$EQUATION, ignore.case = TRUE)
# trp_gem <- human_gem[trp_matches, ]
```

Function that plots given reaction ID
```{r}
# Function that makes boxplots for the flux given the reaction ID
make_boxplots_for_reaction <- function(reaction_name){
  reaction_df <- GSC_flux_t[, reaction_name]
  merged_reaction_df <- merge(as.data.frame(reaction_df), gsva_results_t, by = "row.names")

  boxplot <- ggplot(merged_reaction_df, aes(x = subtype, y = reaction_df, fill = subtype)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = paste("Flux Distribution of ", reaction_name, " by Subtype"),
    x = "Subtype",
    y = paste("Flux", reaction_name)
  ) +
  theme(legend.position = "none")  # remove legend if fill duplicates x-axis
  print(boxplot)
  
  ttest_result <- t.test(reaction_df ~ subtype, data = merged_reaction_df)
  print(ttest_result)
}

make_boxplots_for_reaction("HMR_5651")

```

```{r}
#make_boxplots_for_reaction("HMR_9034")
#make_boxplots_for_reaction("CYTDt2r")
#make_boxplots_for_reaction("HMR_4628")
#make_boxplots_for_reaction("FUMtr")
make_boxplots_for_reaction("HMR_4398")
make_boxplots_for_reaction("HMR_5330")
```


## Make Volcano Plot
Calculate mean flux difference and p-value across all reactions
FDR calculated as well
```{r}
# Convert flux matrix to dataframe
GSC_flux_t_nonzero_df <- as.data.frame(GSC_flux_t_nonzero)


# Merge gsva labels GSC flux dataframe
merged_df_with_labels <- merge(gsva_results_t, GSC_flux_t_nonzero_df, by = "row.names")

rownames(merged_df_with_labels) <- merged_df_with_labels$Row.names
merged_df_with_labels <- merged_df_with_labels[, -c(1, 2, 3)]
```

```{r}
write.csv(GSC_flux_t_nonzero_df, file = "GSC_flux_t_nonzero_df.csv", row.names = TRUE)
```

```{r}
# Check if the flux for one reaction is normally distributed. Yes, seems like it
shapiro.test(merged_df_with_labels$HMR_5330)

```

```{r}
# --- 1. List of reaction columns (exclude 'subtype') ---
reaction_cols <- setdiff(names(merged_df_with_labels), "subtype")

# --- 2. Function to calculate p-value for a single reaction ---
calc_pvalue <- function(reaction) {
  wilcox.test(merged_df_with_labels[[reaction]] ~ merged_df_with_labels$subtype)$p.value
}

# --- 3. Apply function to all reactions ---
results <- sapply(reaction_cols, calc_pvalue)

```

```{r}
# Make into dataframe
results_df <- data.frame(P_value = results)

# Adjust p-values
results_df$adj_P_value <- p.adjust(results_df$P_value, method = "fdr")
results_df <- results_df[-c(1,2,3), ]

```

```{r}
print(merged_df_with_labels[1:5, 1:5])
```

Calculate mean flux values for each subtype, then calculate mean difference and log2FC
```{r}
# --- 1. Split data by subtype ---
dev_flux <- subset(merged_df_with_labels, subtype == "developmental")
dev_flux <- dev_flux[,5:ncol(dev_flux)]
ir_flux  <- subset(merged_df_with_labels, subtype == "injury_response")
ir_flux <- ir_flux[,5:ncol(ir_flux)]

dev_means <- colMeans(dev_flux, na.rm = TRUE)
ir_means  <- colMeans(ir_flux, na.rm = TRUE)
```

```{r}
results_means <- data.frame(
  dev_mean  = dev_means,
  ir_mean   = ir_means[names(dev_means)]  # align by reaction names
)
```

```{r}
# Label the reactions if they are opposite in sign
results_means$opposite <- (results_means$dev_mean * results_means$ir_mean) < 0

# Calculate log2FC only for reactions that are not opposite in sign and have non-zero means
results_means$log2FC <- NA
mask <- !results_means$opposite & (results_means$dev_mean * results_means$ir_mean != 0)
results_means$log2FC[mask] <- log2(results_means$dev_mean[mask] / results_means$ir_mean[mask])

# Add mean difference column to results_means
results_means$mean_diff <- results_means$dev_mean - results_means$ir_mean



# Convert row names to a column first
results_df$Reaction <- rownames(results_df)
results_means$Reaction <- rownames(results_means)

# Merge by the Reaction column
results_df <- merge(results_df, results_means, by = "Reaction")

# Set row names back if desired
rownames(results_df) <- results_df$Reaction

head(results_df)

```

```{r}
# Mark significance based on FDR threshold
results_df$sig <- ifelse(results_df$adj_P_value < 0.05, "Significant", "NS")
results_df$negLog10FDR <- -log10(results_df$adj_P_value)
```

```{r}
# Load the human GEM model to annotate reactions
data("human_gem")

# Merge reaction annotations (e.g., subsystem, equation) into results_df
results_df <- merge(results_df, human_gem[, c("ID", "SUBSYSTEM", "EQUATION", "GENE ASSOCIATION")], 
          by.x = "Reaction", by.y = "ID", all.x = TRUE)

#head(results_df[, c("Reaction", "SUBSYSTEM", "EQUATION")])

```



```{r}
write.csv(results_df, file = "GSC_tissue_bulk_METAFlux_full_results.csv", row.names = TRUE)
```




```{r}
library(ggplot2)
library(ggrepel)
library(dplyr)



ggplot(results_df, aes(x = log2FC, y = negLog10FDR, color = sig)) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Significant" = "red", "NS" = "grey")) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_minimal() +
  labs(
    x = "Log2 Fold Change (Developmental / Injury Response)",
    y = "-log10(FDR)",
    color = "Significance"
  ) +
  geom_text_repel(
    data = rbind(
      results_df %>% filter(sig == "Significant") %>% arrange(desc(log2FC)) %>% head(10),
      results_df %>% filter(sig == "Significant") %>% arrange(log2FC) %>% head(10)
    ),
    aes(label = Reaction),
    max.overlaps = 30,
    size = 5,
    box.padding = 0.2,
    min.segment.length = 0
  )
```


## Make Pie Charts
Made a pie chart using the dataframe containing only significant hits, summarized the most frequently appearing top 5 subsystem labels in a pie chart. Compared this to a pie chart made similarly with all of the reactions in the human1 GEM model. 
Perhaps most striking is the increased percentage of reactions related to peptide metabolism. It represents only 1.8% of the entire set of reactions but 19.1% of the reactions with differential flux between developmental and IR subtypes
```{r}
# Count reactions per subsystem
pie_counts <- table(human_gem$SUBSYSTEM)

# Sort descending
pie_counts <- sort(pie_counts, decreasing = TRUE)

# print(pie_counts)
print(pie_counts["Peptide metabolism"]/sum(pie_counts))

# Keep top 5, sum the rest as "Other"
top_n <- 5
if(length(pie_counts) > top_n){
  top_counts <- pie_counts[1:top_n]
  other_count <- sum(pie_counts[(top_n + 1):length(pie_counts)])
  pie_counts <- c(top_counts, Other = other_count)
}

# Calculate percentages
labels <- paste(names(pie_counts), round(100 * pie_counts / sum(pie_counts), 1), "%")

# Create pie chart
pie(pie_counts, labels = labels, main = "Top 5 Subsystems (Others grouped)", col = rainbow(length(pie_counts)))
```
```{r}
# Count reactions per subsystem
pie_counts_sig <- table(significant_df$SUBSYSTEM)

# Sort descending
pie_counts_sig <- sort(pie_counts_sig, decreasing = TRUE)

# Keep top 5, sum the rest as "Other"
top_n_sig <- 5
if(length(pie_counts_sig) > top_n_sig){
  top_counts <- pie_counts_sig[1:top_n_sig]
  other_count <- sum(pie_counts_sig[(top_n_sig + 1):length(pie_counts_sig)])
  pie_counts_sig <- c(top_counts, Other = other_count)
}

# Calculate percentages
labels <- paste(names(pie_counts_sig), round(100 * pie_counts_sig / sum(pie_counts_sig), 1), "%")

# Create pie chart
pie(pie_counts_sig, labels = labels, main = "Top 5 Subsystems (Others grouped)", col = rainbow(length(pie_counts_sig)))

```

## Look into glycolysis reactions

```{r}
# Get all reactions corresponding to the subsystem Glycolysis / Gluconeogenesis
glycolysis_rxns <- human_gem[human_gem$SUBSYSTEM == "Glycolysis / Gluconeogenesis",'ID']
glycolysis_columns <- c("subtype", glycolysis_rxns$ID)
glycolysis_columns

glycolysis_matrix <- merged_df_with_labels[, glycolysis_columns]
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)

# Example dataframe
# rows = samples, columns = reactions, plus a subtype column
# df <- data.frame(
#   Reaction1 = rnorm(10), Reaction2 = rnorm(10),
#   Reaction3 = rnorm(10),
#   subtype = rep(c("developmental", "injury_response"), each=5)
# )

# Convert to long format
df_long <- glycolysis_matrix %>%
  pivot_longer(
    cols = -subtype,
    names_to = "Reaction",
    values_to = "Flux"
  )

```

```{r}
df_median <- df_long %>%
  group_by(Reaction, subtype) %>%
  summarize(median_flux = median(Flux), .groups = "drop")

```

```{r}
sig_df <- df_long %>%
  group_by(Reaction) %>%
  summarize(
    max_flux = max(Flux),
    p_value = wilcox.test(Flux ~ subtype)$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    signif = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    y_pos = max_flux * 1.05  # place stars slightly above the tallest bar
  )

```

```{r}


ggplot(df_median, aes(x = Reaction, y = median_flux, fill = subtype)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  geom_text(
    data = sig_df,
    aes(x = Reaction, y = y_pos, label = signif),
    inherit.aes = FALSE,
    position = position_dodge(width = 0.8)
  ) +
  scale_fill_manual(values = c("developmental" = "steelblue", "injury_response" = "tomato")) +
  theme_minimal() +
  labs(y = "Median Flux", fill = "Subtype") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
  ylim(-0.02, 0.02)  # set y-axis range manually
```

```{r}
library(ggplot2)
library(dplyr)

# df_median should have columns: Reaction, subtype, median_flux

ggplot(df_median, aes(x = Reaction, y = median_flux, fill = subtype)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("developmental" = "steelblue", "injury_response" = "tomato")) +
  theme_minimal() +
  labs(y = "Median Flux", fill = "Subtype") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(-0.002, 0.002))  # optional fixed y-range

```



```{r}
library(dplyr)
library(ggplot2)

# Make sure df_median has columns: Reaction, subtype, median_flux
# Pivot so each reaction has one row with median_flux per subtype
df_fc <- df_median %>%
  tidyr::pivot_wider(names_from = subtype, values_from = median_flux) %>%
  mutate(
    log2FC = log2(`injury_response` / `developmental`)
  )

# Join p-values from sig_df
volcano_df <- df_fc %>%
  left_join(sig_df %>% select(Reaction, p_value), by = "Reaction") %>%
  mutate(
    negLog10P = -log10(p_value),
    sig = ifelse(p_value < 0.05, "Significant", "NS")
  )

```
```{r}
ggplot(volcano_df, aes(x = log2FC, y = negLog10P, color = sig)) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Significant" = "red", "NS" = "grey")) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_minimal() +
  labs(
    x = "Log2 Fold Change (injury_response / developmental)",
    y = "-Log10(P-value)",
    color = ""
  )

```

```{r}
library(ggrepel)

ggplot(volcano_df, aes(x = log2FC, y = negLog10P, color = sig)) +
  geom_point(size = 3) +
  geom_text_repel(
    data = subset(volcano_df, p_value < 0.01),
    aes(label = Reaction),
    size = 3
  ) +
  scale_color_manual(values = c("Significant" = "red", "NS" = "grey")) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_minimal()

```







